<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
        button { padding: 10px; margin: 5px; }
        #log { 
            height: 300px; 
            overflow: auto; 
            padding: 10px; 
            background: #f5f5f5; 
            border: 1px solid #ddd;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Contract Connection Test</h1>
    
    <div class="section">
        <h2>Status</h2>
        <p id="libraryStatus">Checking ethers.js...</p>
        <p id="walletStatus">Checking wallet...</p>
        <p id="contractStatus">Contract not connected</p>
    </div>
    
    <div class="section">
        <h2>Actions</h2>
        <button id="connectWallet">Connect Wallet</button>
        <button id="checkContract">Check Contract</button>
        <button id="getEventCount">Get Event Count</button>
    </div>
    
    <div id="log">
        <p>Logs will appear here...</p>
    </div>

    <!-- Load ethers.js from unpkg -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <script>
        // Log helper function
        function log(message, isError = false) {
            const logElem = document.getElementById('log');
            const msgElem = document.createElement('p');
            msgElem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) msgElem.className = 'error';
            logElem.appendChild(msgElem);
            logElem.scrollTop = logElem.scrollHeight;
            console.log(message);
        }
        
        // Contract details
        const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        
        // Simplified ABI with just the function we need
        const contractABI = [
            {
                "inputs": [],
                "name": "getEventCount",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        
        let provider;
        let signer;
        let contract;
        
        // Check if ethers is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('libraryStatus');
            
            if (typeof ethers !== 'undefined') {
                statusElement.textContent = "✅ ethers.js is properly loaded! Version: " + ethers.version;
                statusElement.className = "success";
                log("ethers.js loaded: " + ethers.version);
                
                // Check for wallet
                checkWallet();
            } else {
                statusElement.textContent = "❌ ethers.js failed to load!";
                statusElement.className = "error";
                log("ethers.js failed to load", true);
            }
        });
        
        // Check wallet
        function checkWallet() {
            const walletStatus = document.getElementById('walletStatus');
            
            if (window.ethereum) {
                walletStatus.textContent = "✅ MetaMask is available";
                walletStatus.className = "success";
                log("MetaMask detected");
            } else {
                walletStatus.textContent = "❌ MetaMask not detected";
                walletStatus.className = "error";
                log("MetaMask not detected", true);
            }
        }
        
        // Connect wallet
        async function connectWallet() {
            log("Attempting to connect wallet...");
            try {
                if (!window.ethereum) {
                    throw new Error("No Ethereum wallet found. Please install MetaMask.");
                }
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await window.ethereum.request({ method: "eth_requestAccounts" });
                signer = provider.getSigner();
                const userAddress = await signer.getAddress();
                
                log(`Wallet connected: ${userAddress}`);
                
                document.getElementById('walletStatus').textContent = `✅ Connected: ${userAddress}`;
                document.getElementById('walletStatus').className = "success";
                
                return true;
            } catch (error) {
                log(`Error connecting wallet: ${error.message}`, true);
                return false;
            }
        }
        
        // Connect to contract
        async function connectContract() {
            log("Attempting to connect to contract at " + contractAddress);
            try {
                if (!signer) {
                    const connected = await connectWallet();
                    if (!connected) throw new Error("Wallet not connected");
                }
                
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                log("Contract instance created");
                
                document.getElementById('contractStatus').textContent = `✅ Contract connected at ${contractAddress}`;
                document.getElementById('contractStatus').className = "success";
                
                return true;
            } catch (error) {
                log(`Error connecting to contract: ${error.message}`, true);
                document.getElementById('contractStatus').textContent = `❌ Contract connection failed`;
                document.getElementById('contractStatus').className = "error";
                return false;
            }
        }
        
        // Get event count
        async function getEventCount() {
            log("Attempting to get event count...");
            try {
                if (!contract) {
                    const connected = await connectContract();
                    if (!connected) throw new Error("Contract not connected");
                }
                
                const count = await contract.getEventCount();
                log(`Event count: ${count.toString()}`);
            } catch (error) {
                log(`Error getting event count: ${error.message}`, true);
            }
        }
        
        // Attach event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('checkContract').addEventListener('click', connectContract);
        document.getElementById('getEventCount').addEventListener('click', getEventCount);
        
        log("Page initialization complete");
    </script>
</body>
</html>
