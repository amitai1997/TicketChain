<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicketChain - Minimal Version</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .card { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 5px; }
        button { padding: 10px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2980b9; }
        .success { color: green; }
        .error { color: red; }
        #logs { height: 200px; overflow: auto; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>TicketChain - Minimal Demo</h1>
    
    <div class="card">
        <h2>Status</h2>
        <p id="ethersStatus">Checking ethers.js...</p>
        <p id="walletStatus">Checking wallet...</p>
        <p id="contractStatus">Contract status: Not connected</p>
    </div>
    
    <div class="card">
        <h2>Actions</h2>
        <button id="connectBtn">Connect Wallet</button>
        <button id="getEventsBtn">Get Events</button>
        <button id="createEventBtn">Create Test Event</button>
    </div>
    
    <div class="card">
        <h2>Event List</h2>
        <div id="eventList">Connect wallet to see events</div>
    </div>
    
    <div class="card">
        <h2>Debug Logs</h2>
        <div id="logs"></div>
    </div>
    
    <!-- Load ethers.js from unpkg -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <script>
        // Helper function for logging
        function log(message) {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        // Check if ethers.js loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof ethers !== 'undefined') {
                document.getElementById('ethersStatus').textContent = `ethers.js loaded (${ethers.version})`;
                document.getElementById('ethersStatus').className = 'success';
                log(`ethers.js loaded: ${ethers.version}`);
            } else {
                document.getElementById('ethersStatus').textContent = 'ERROR: ethers.js not loaded!';
                document.getElementById('ethersStatus').className = 'error';
                log('ERROR: ethers.js not loaded!');
            }
            
            if (window.ethereum) {
                document.getElementById('walletStatus').textContent = 'MetaMask detected';
                document.getElementById('walletStatus').className = 'success';
                log('MetaMask detected');
            } else {
                document.getElementById('walletStatus').textContent = 'No Ethereum wallet detected. Please install MetaMask.';
                document.getElementById('walletStatus').className = 'error';
                log('No Ethereum wallet detected');
            }
        });
        
        // Contract details
        const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        const contractABI = [
            // Only include essential functions for minimal testing
            {"inputs":[],"name":"getEventCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"eventId","type":"uint256"}],"name":"getEvent","outputs":[{"components":[{"internalType":"uint256","name":"eventId","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"ticketPrice","type":"uint256"},{"internalType":"uint256","name":"maxTickets","type":"uint256"},{"internalType":"uint256","name":"ticketsSold","type":"uint256"},{"internalType":"uint256","name":"eventDate","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"address","name":"organizer","type":"address"},{"internalType":"uint256","name":"minResalePrice","type":"uint256"},{"internalType":"uint256","name":"maxResalePrice","type":"uint256"},{"internalType":"uint256","name":"royaltyPercentage","type":"uint256"}],"internalType":"struct TicketNFT.Event","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"ticketPrice","type":"uint256"},{"internalType":"uint256","name":"maxTickets","type":"uint256"},{"internalType":"uint256","name":"eventDate","type":"uint256"},{"internalType":"uint256","name":"minResalePrice","type":"uint256"},{"internalType":"uint256","name":"maxResalePrice","type":"uint256"},{"internalType":"uint256","name":"royaltyPercentage","type":"uint256"}],"name":"createEvent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"}
        ];
        
        // Global variables
        let provider;
        let signer;
        let contract;
        
        // Connect to MetaMask
        async function connectWallet() {
            try {
                log('Connecting to wallet...');
                if (!window.ethereum) {
                    throw new Error('No Ethereum provider found. Please install MetaMask.');
                }
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                log(`Connected to wallet: ${address}`);
                document.getElementById('walletStatus').textContent = `Connected: ${address}`;
                
                // Connect to contract
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                log(`Connected to contract at ${contractAddress}`);
                document.getElementById('contractStatus').textContent = `Contract connected at ${contractAddress}`;
                document.getElementById('contractStatus').className = 'success';
                
                return true;
            } catch (error) {
                log(`Error connecting: ${error.message}`);
                document.getElementById('contractStatus').textContent = `Error: ${error.message}`;
                document.getElementById('contractStatus').className = 'error';
                return false;
            }
        }
        
        // Get events
        async function getEvents() {
            try {
                if (!contract) {
                    if (!(await connectWallet())) return;
                }
                
                log('Getting event count...');
                const count = await contract.getEventCount();
                log(`Found ${count.toString()} events`);
                
                const eventListDiv = document.getElementById('eventList');
                eventListDiv.innerHTML = '';
                
                if (count.toNumber() === 0) {
                    eventListDiv.innerHTML = '<p>No events found. Create one!</p>';
                    return;
                }
                
                for (let i = 1; i <= count; i++) {
                    log(`Loading event ${i}...`);
                    const event = await contract.getEvent(i);
                    
                    const eventCard = document.createElement('div');
                    eventCard.className = 'card';
                    
                    const date = new Date(event.eventDate.toNumber() * 1000);
                    
                    eventCard.innerHTML = `
                        <h3>${event.name}</h3>
                        <p>${event.description}</p>
                        <p>Price: ${ethers.utils.formatEther(event.ticketPrice)} ETH</p>
                        <p>Date: ${date.toLocaleString()}</p>
                        <p>Available: ${event.maxTickets.toNumber() - event.ticketsSold.toNumber()} / ${event.maxTickets.toNumber()}</p>
                        <button onclick="mintTicket(${event.eventId})">Buy Ticket</button>
                    `;
                    
                    eventListDiv.appendChild(eventCard);
                }
            } catch (error) {
                log(`Error getting events: ${error.message}`);
            }
        }
        
        // Create test event
        async function createTestEvent() {
            try {
                if (!contract) {
                    if (!(await connectWallet())) return;
                }
                
                log('Creating test event...');
                
                const name = "Test Event " + Date.now();
                const description = "This is a test event created on " + new Date().toLocaleString();
                const ticketPrice = ethers.utils.parseEther("0.01");  // 0.01 ETH
                const maxTickets = 100;
                const eventDate = Math.floor(Date.now() / 1000) + 86400;  // Tomorrow
                const minResalePrice = ethers.utils.parseEther("0.005");  // 0.005 ETH
                const maxResalePrice = ethers.utils.parseEther("0.02");   // 0.02 ETH
                const royaltyPercentage = 500;  // 5%
                
                const tx = await contract.createEvent(
                    name,
                    description,
                    ticketPrice,
                    maxTickets,
                    eventDate,
                    minResalePrice,
                    maxResalePrice,
                    royaltyPercentage
                );
                
                log(`Transaction sent: ${tx.hash}`);
                log('Waiting for confirmation...');
                
                await tx.wait();
                log('Event created successfully!');
                
                // Refresh event list
                getEvents();
            } catch (error) {
                log(`Error creating event: ${error.message}`);
            }
        }
        
        // Add event listeners
        document.getElementById('connectBtn').addEventListener('click', connectWallet);
        document.getElementById('getEventsBtn').addEventListener('click', getEvents);
        document.getElementById('createEventBtn').addEventListener('click', createTestEvent);
        
        log('Page initialized');
    </script>
</body>
</html>
